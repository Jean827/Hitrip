# 安全加固方案

## 概述

本文档详细描述了海南文旅系统安全加固的实施方案，包括安全中间件、安全扫描器、安全测试和加固措施。

## 安全架构

### 1. 安全中间件层

#### 1.1 安全头配置
```typescript
// 内容安全策略 (CSP)
contentSecurityPolicy: {
  directives: {
    defaultSrc: ["'self'"],
    styleSrc: ["'self'", "'unsafe-inline'", "https://fonts.googleapis.com"],
    fontSrc: ["'self'", "https://fonts.gstatic.com"],
    imgSrc: ["'self'", "data:", "https:"],
    scriptSrc: ["'self'", "'unsafe-inline'", "'unsafe-eval'"],
    connectSrc: ["'self'", "https://api.example.com"],
    frameSrc: ["'none'"],
    objectSrc: ["'none'"]
  }
}

// HTTP严格传输安全 (HSTS)
hsts: {
  maxAge: 31536000,
  includeSubDomains: true,
  preload: true
}
```

#### 1.2 CORS配置
```typescript
const allowedOrigins = [
  'http://localhost:3000',
  'http://localhost:5173',
  'https://hainan-tourism.com',
  'https://www.hainan-tourism.com'
];
```

#### 1.3 输入验证
- SQL注入防护
- XSS攻击防护
- 路径遍历防护
- 命令注入防护

### 2. 安全扫描器

#### 2.1 攻击检测
```typescript
// SQL注入检测
const sqlPatterns = [
  /(\b(union|select|insert|update|delete|drop|create|alter|exec|execute)\b)/i,
  /(\b(1=1|1'='1|1"='1)\b)/i,
  /(\b(or|and)\s+\d+\s*=\s*\d+)/i
];

// XSS攻击检测
const xssPatterns = [
  /<script[^>]*>.*?<\/script>/gi,
  /javascript:/gi,
  /onload\s*=/gi,
  /onerror\s*=/gi
];
```

#### 2.2 恶意工具检测
```typescript
const maliciousPatterns = [
  /sqlmap/i,
  /nmap/i,
  /nikto/i,
  /burpsuite/i,
  /acunetix/i
];
```

### 3. 安全测试

#### 3.1 测试类型
1. **安全头检查**
   - X-Content-Type-Options
   - X-Frame-Options
   - X-XSS-Protection
   - Strict-Transport-Security
   - Referrer-Policy

2. **CORS配置检查**
   - 允许的源
   - 允许的方法
   - 允许的头部

3. **输入验证测试**
   - SQL注入防护
   - XSS防护
   - 路径遍历防护

4. **认证授权测试**
   - 密码强度检查
   - 令牌生成验证
   - 权限检查

5. **速率限制测试**
   - 请求频率限制
   - 登录尝试限制

#### 3.2 测试脚本
```javascript
// 安全加固测试
const securityTests = [
  {
    name: '安全头检查',
    method: 'GET',
    path: '/api/security/health',
    expectedHeaders: [
      'X-Content-Type-Options',
      'X-Frame-Options',
      'X-XSS-Protection'
    ]
  },
  {
    name: 'SQL注入防护测试',
    method: 'POST',
    path: '/api/security/sanitize-input',
    body: JSON.stringify({
      input: "'; DROP TABLE users; --"
    }),
    expectedStatus: 400
  }
];
```

## 安全加固措施

### 1. 输入验证加固

#### 1.1 数据清理
```typescript
sanitizeInput(input: string): string {
  return input
    .replace(/[<>]/g, '') // 移除尖括号
    .replace(/javascript:/gi, '') // 移除javascript:
    .replace(/vbscript:/gi, '') // 移除vbscript:
    .replace(/on\w+\s*=/gi, '') // 移除事件处理器
    .trim();
}
```

#### 1.2 密码强度检查
```typescript
checkPasswordStrength(password: string): {
  isValid: boolean;
  score: number;
  suggestions: string[];
} {
  // 长度检查 (至少8位)
  // 包含小写字母
  // 包含大写字母
  // 包含数字
  // 包含特殊字符
  // 避免常见弱密码
}
```

### 2. 文件上传安全

#### 2.1 文件类型限制
```typescript
const allowedMimeTypes = [
  'image/jpeg',
  'image/png',
  'image/gif',
  'image/webp',
  'application/pdf',
  'text/plain'
];
```

#### 2.2 文件大小限制
```typescript
const maxFileSize = 5 * 1024 * 1024; // 5MB
```

### 3. 会话安全

#### 3.1 安全Cookie设置
```typescript
res.cookie('sessionId', req.sessionID, {
  httpOnly: true,
  secure: process.env.NODE_ENV === 'production',
  sameSite: 'strict',
  maxAge: 24 * 60 * 60 * 1000 // 24小时
});
```

#### 3.2 会话超时检查
```typescript
if (sessionAge > 24 * 60 * 60 * 1000) {
  req.session.destroy();
  return res.status(401).json({
    success: false,
    message: '会话已过期，请重新登录'
  });
}
```

### 4. 速率限制

#### 4.1 通用限流
```typescript
const securityRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 限制每个IP 15分钟内最多100个请求
  message: {
    success: false,
    message: '请求过于频繁，请稍后再试'
  }
});
```

#### 4.2 登录限流
```typescript
const loginRateLimit = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 5, // 限制每个IP 15分钟内最多5次登录尝试
  message: {
    success: false,
    message: '登录尝试过于频繁，请稍后再试'
  }
});
```

### 5. 安全监控

#### 5.1 安全事件记录
```typescript
logSecurityEvent(type: string, data: any): void {
  const event = {
    type,
    data,
    timestamp: new Date().toISOString(),
    id: crypto.randomBytes(8).toString('hex')
  };
  
  this.securityEvents.push(event);
  console.warn('安全事件:', event);
}
```

#### 5.2 IP阻止机制
```typescript
blockIP(ip: string): void {
  this.blockedIPs.add(ip);
  this.logSecurityEvent('ip_blocked', { ip });
}

isIPBlocked(ip: string): boolean {
  return this.blockedIPs.has(ip);
}
```

## 安全API接口

### 1. 安全扫描API
```
GET /api/security/scan
- 执行综合安全检查
- 返回安全报告

GET /api/security/events
- 获取安全事件列表

DELETE /api/security/events
- 清理安全事件
```

### 2. 密码安全API
```
POST /api/security/check-password
- 检查密码强度

POST /api/security/hash-password
- 密码哈希

POST /api/security/verify-password
- 密码验证
```

### 3. 令牌管理API
```
POST /api/security/generate-token
- 生成安全令牌

POST /api/security/sanitize-input
- 输入清理测试
```

### 4. IP管理API
```
GET /api/security/blocked-ips
- 获取被阻止IP列表

POST /api/security/block-ip
- 阻止IP

POST /api/security/unblock-ip
- 解除IP阻止
```

## 安全配置

### 1. 环境变量
```bash
# 安全配置
NODE_ENV=production
JWT_SECRET=your-super-secret-jwt-key
SESSION_SECRET=your-super-secret-session-key

# 数据库安全
DB_SSL=true
DB_SSL_REJECT_UNAUTHORIZED=true

# 文件上传安全
MAX_FILE_SIZE=5242880
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/gif,image/webp,application/pdf,text/plain
```

### 2. 安全头配置
```typescript
// 安全响应头
res.setHeader('X-Content-Type-Options', 'nosniff');
res.setHeader('X-Frame-Options', 'DENY');
res.setHeader('X-XSS-Protection', '1; mode=block');
res.setHeader('Strict-Transport-Security', 'max-age=31536000; includeSubDomains');
res.setHeader('Referrer-Policy', 'strict-origin-when-cross-origin');
res.setHeader('Permissions-Policy', 'geolocation=(), microphone=(), camera=()');
```

## 安全测试报告

### 测试统计
- **总测试数**: 25
- **通过**: 23
- **失败**: 2
- **成功率**: 92.0%

### 测试结果
✅ 安全头检查
✅ CORS配置检查
✅ SQL注入防护测试
✅ XSS防护测试
✅ 路径遍历防护测试
✅ 密码强度检查
✅ 令牌生成测试
✅ 密码哈希测试
❌ 速率限制测试 (需要调整配置)
❌ 文件上传安全检查 (需要完善实现)

### 安全建议
1. **定期更新安全补丁**
2. **实施强密码策略**
3. **启用双因素认证**
4. **监控异常活动**
5. **定期备份数据**
6. **完善文件上传安全机制**
7. **优化速率限制配置**

## 实施计划

### 第一阶段：基础安全加固
- [x] 安全中间件实现
- [x] 安全扫描器开发
- [x] 基础安全测试

### 第二阶段：高级安全功能
- [ ] 双因素认证
- [ ] 安全审计日志
- [ ] 实时安全监控
- [ ] 自动安全响应

### 第三阶段：安全运维
- [ ] 安全事件响应流程
- [ ] 安全培训计划
- [ ] 定期安全评估
- [ ] 安全合规检查

## 总结

通过实施全面的安全加固方案，系统具备了：

1. **多层安全防护**：从网络层到应用层的全面保护
2. **智能威胁检测**：自动识别和阻止恶意攻击
3. **完善的安全监控**：实时监控和记录安全事件
4. **灵活的安全配置**：可根据需求调整安全策略
5. **全面的安全测试**：确保安全措施的有效性

这些安全措施为海南文旅系统提供了强有力的安全保障，确保用户数据和系统安全。 