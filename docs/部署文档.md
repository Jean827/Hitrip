# 海南文旅平台部署文档

## 📋 概述

本文档详细说明了海南文旅平台的部署流程，包括环境要求、配置步骤、部署方法和维护指南。

## 🖥️ 系统要求

### 服务器要求
- **操作系统**: Ubuntu 20.04+ / CentOS 8+ / macOS 12+
- **CPU**: 2核心以上
- **内存**: 4GB以上
- **存储**: 20GB以上可用空间
- **网络**: 稳定的网络连接

### 软件要求
- **Node.js**: 18.x 或更高版本
- **npm**: 9.x 或更高版本
- **PostgreSQL**: 13.x 或更高版本
- **Redis**: 6.x 或更高版本
- **Docker**: 20.x 或更高版本 (可选)
- **Docker Compose**: 2.x 或更高版本 (可选)

## 🚀 快速部署

### 使用 Docker Compose (推荐)

1. **克隆项目**
```bash
git clone https://github.com/your-org/hitrip.git
cd hitrip
```

2. **配置环境变量**
```bash
cp backend/env.example backend/.env
cp frontend/env.example frontend/.env
```

编辑 `backend/.env`:
```env
# 数据库配置
DB_HOST=postgres
DB_PORT=5432
DB_NAME=hitrip
DB_USER=hitrip_user
DB_PASSWORD=your_secure_password

# Redis配置
REDIS_HOST=redis
REDIS_PORT=6379

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRES_IN=24h

# 服务器配置
PORT=3001
NODE_ENV=production

# 支付配置
WECHAT_APP_ID=your_wechat_app_id
WECHAT_MCH_ID=your_wechat_mch_id
WECHAT_API_KEY=your_wechat_api_key
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY=your_alipay_private_key
ALIPAY_PUBLIC_KEY=your_alipay_public_key

# 文件上传配置
UPLOAD_PATH=/uploads
MAX_FILE_SIZE=10485760

# 邮件配置
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your_email@gmail.com
SMTP_PASS=your_email_password

# 短信配置
SMS_PROVIDER=aliyun
SMS_ACCESS_KEY=your_sms_access_key
SMS_SECRET_KEY=your_sms_secret_key
SMS_SIGN_NAME=your_sms_sign_name
SMS_TEMPLATE_CODE=your_sms_template_code
```

编辑 `frontend/.env`:
```env
VITE_API_BASE_URL=http://localhost:3001/api
VITE_APP_TITLE=海南文旅平台
VITE_APP_DESCRIPTION=海南文旅综合服务平台
```

3. **启动服务**
```bash
docker-compose up -d
```

4. **初始化数据库**
```bash
docker-compose exec backend npm run db:migrate
docker-compose exec backend npm run db:seed
```

5. **访问应用**
- 前端: http://localhost:3000
- 后端API: http://localhost:3001
- API文档: http://localhost:3001/api-docs

## 🔧 手动部署

### 1. 环境准备

#### 安装 Node.js
```bash
# Ubuntu/Debian
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS/RHEL
curl -fsSL https://rpm.nodesource.com/setup_18.x | sudo bash -
sudo yum install -y nodejs

# macOS
brew install node@18
```

#### 安装 PostgreSQL
```bash
# Ubuntu/Debian
sudo apt-get update
sudo apt-get install -y postgresql postgresql-contrib

# CentOS/RHEL
sudo yum install -y postgresql-server postgresql-contrib
sudo postgresql-setup initdb
sudo systemctl start postgresql
sudo systemctl enable postgresql

# macOS
brew install postgresql
brew services start postgresql
```

#### 安装 Redis
```bash
# Ubuntu/Debian
sudo apt-get install -y redis-server

# CentOS/RHEL
sudo yum install -y redis
sudo systemctl start redis
sudo systemctl enable redis

# macOS
brew install redis
brew services start redis
```

### 2. 数据库配置

#### 创建数据库和用户
```sql
-- 连接到PostgreSQL
sudo -u postgres psql

-- 创建数据库
CREATE DATABASE hitrip;

-- 创建用户
CREATE USER hitrip_user WITH PASSWORD 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON DATABASE hitrip TO hitrip_user;

-- 退出
\q
```

### 3. 后端部署

#### 安装依赖
```bash
cd backend
npm install
```

#### 配置环境变量
```bash
cp env.example .env
# 编辑 .env 文件，配置数据库连接等信息
```

#### 数据库迁移
```bash
npm run db:migrate
npm run db:seed
```

#### 启动服务
```bash
# 开发环境
npm run dev

# 生产环境
npm run build
npm start

# 使用PM2 (推荐)
npm install -g pm2
pm2 start ecosystem.config.js
```

### 4. 前端部署

#### 安装依赖
```bash
cd frontend
npm install
```

#### 构建项目
```bash
npm run build
```

#### 部署静态文件
```bash
# 使用 nginx
sudo apt-get install -y nginx
sudo cp -r dist/* /var/www/html/
sudo systemctl restart nginx

# 或使用其他静态文件服务器
npm install -g serve
serve -s dist -l 3000
```

## 🔒 安全配置

### 1. 防火墙配置
```bash
# Ubuntu/Debian
sudo ufw enable
sudo ufw allow 22
sudo ufw allow 80
sudo ufw allow 443
sudo ufw allow 3001

# CentOS/RHEL
sudo firewall-cmd --permanent --add-port=22/tcp
sudo firewall-cmd --permanent --add-port=80/tcp
sudo firewall-cmd --permanent --add-port=443/tcp
sudo firewall-cmd --permanent --add-port=3001/tcp
sudo firewall-cmd --reload
```

### 2. SSL证书配置
```bash
# 安装 Certbot
sudo apt-get install -y certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d your-domain.com

# 自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

### 3. 数据库安全
```bash
# 修改PostgreSQL配置
sudo nano /etc/postgresql/13/main/postgresql.conf

# 添加以下配置
listen_addresses = 'localhost'
max_connections = 100
shared_buffers = 256MB
effective_cache_size = 1GB

# 修改访问控制
sudo nano /etc/postgresql/13/main/pg_hba.conf

# 添加以下行
local   hitrip          hitrip_user                           md5
host    hitrip          hitrip_user           127.0.0.1/32    md5
```

## 📊 监控和日志

### 1. 应用监控
```bash
# 安装PM2监控
pm2 install pm2-logrotate
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30

# 查看应用状态
pm2 status
pm2 logs
pm2 monit
```

### 2. 系统监控
```bash
# 安装htop
sudo apt-get install -y htop

# 安装iotop
sudo apt-get install -y iotop

# 安装nethogs
sudo apt-get install -y nethogs
```

### 3. 日志管理
```bash
# 配置logrotate
sudo nano /etc/logrotate.d/hitrip

# 添加以下配置
/var/log/hitrip/*.log {
    daily
    missingok
    rotate 52
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
    postrotate
        pm2 reloadLogs
    endscript
}
```

## 🔄 备份和恢复

### 1. 数据库备份
```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup_hitrip.sh

#!/bin/bash
BACKUP_DIR="/backup/hitrip"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="hitrip"
DB_USER="hitrip_user"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -U $DB_USER $DB_NAME > $BACKUP_DIR/hitrip_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/hitrip_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "hitrip_*.sql.gz" -mtime +7 -delete

echo "Backup completed: hitrip_$DATE.sql.gz"
```

```bash
# 设置执行权限
sudo chmod +x /usr/local/bin/backup_hitrip.sh

# 添加到定时任务
sudo crontab -e
# 添加以下行 (每天凌晨2点备份)
0 2 * * * /usr/local/bin/backup_hitrip.sh
```

### 2. 文件备份
```bash
# 备份上传文件
sudo tar -czf /backup/hitrip/uploads_$(date +%Y%m%d_%H%M%S).tar.gz /var/www/uploads/

# 备份配置文件
sudo tar -czf /backup/hitrip/config_$(date +%Y%m%d_%H%M%S).tar.gz /path/to/config/files/
```

### 3. 恢复数据
```bash
# 恢复数据库
gunzip -c /backup/hitrip/hitrip_20240101_120000.sql.gz | psql -U hitrip_user hitrip

# 恢复文件
sudo tar -xzf /backup/hitrip/uploads_20240101_120000.tar.gz -C /
```

## 🚨 故障排除

### 1. 常见问题

#### 数据库连接失败
```bash
# 检查PostgreSQL服务状态
sudo systemctl status postgresql

# 检查连接配置
sudo nano /etc/postgresql/13/main/postgresql.conf
sudo nano /etc/postgresql/13/main/pg_hba.conf

# 重启PostgreSQL
sudo systemctl restart postgresql
```

#### 应用无法启动
```bash
# 检查端口占用
sudo netstat -tlnp | grep :3001

# 检查日志
pm2 logs
tail -f /var/log/hitrip/error.log

# 检查环境变量
echo $NODE_ENV
echo $DB_HOST
```

#### 内存不足
```bash
# 检查内存使用
free -h
top

# 优化Node.js内存
export NODE_OPTIONS="--max-old-space-size=2048"

# 重启应用
pm2 restart all
```

### 2. 性能优化

#### 数据库优化
```sql
-- 创建索引
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_payments_order ON payments(order_id);

-- 分析查询性能
EXPLAIN ANALYZE SELECT * FROM products WHERE category_id = '1';
```

#### 应用优化
```bash
# 启用gzip压缩
npm install compression

# 启用缓存
npm install redis

# 优化静态文件
npm install -g imagemin
```

## 📞 技术支持

### 联系信息
- **技术支持邮箱**: support@hitrip.com
- **紧急联系电话**: 400-123-4567
- **工作时间**: 周一至周五 9:00-18:00

### 日志收集
```bash
# 收集系统信息
uname -a
cat /etc/os-release
free -h
df -h

# 收集应用日志
pm2 logs --lines 100
tail -n 100 /var/log/hitrip/error.log

# 收集数据库日志
tail -n 100 /var/log/postgresql/postgresql-13-main.log
```

### 更新和维护
```bash
# 更新代码
git pull origin main

# 更新依赖
npm install

# 重启服务
pm2 restart all

# 检查服务状态
pm2 status
```

## 📋 部署检查清单

- [ ] 环境要求检查
- [ ] 数据库配置完成
- [ ] 环境变量配置完成
- [ ] 应用启动成功
- [ ] 数据库迁移完成
- [ ] 初始数据导入完成
- [ ] 防火墙配置完成
- [ ] SSL证书配置完成
- [ ] 监控系统配置完成
- [ ] 备份策略配置完成
- [ ] 性能测试通过
- [ ] 安全测试通过
- [ ] 文档更新完成

---

**部署完成时间**: ___________  
**部署人员**: ___________  
**部署版本**: ___________  
**备注**: ___________ 