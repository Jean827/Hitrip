# 监控配置指南

## 概述

本文档详细介绍了海南文旅系统监控体系的配置和使用方法，包括Prometheus、AlertManager、Grafana等组件的配置。

## 监控架构

### 监控组件

1. **Prometheus** - 数据收集和存储
2. **AlertManager** - 告警管理
3. **Grafana** - 数据可视化
4. **Node Exporter** - 系统指标收集
5. **PostgreSQL Exporter** - 数据库指标收集
6. **Redis Exporter** - 缓存指标收集
7. **Nginx Exporter** - Web服务器指标收集

### 端口分配

- Prometheus: 9090
- AlertManager: 9093
- Grafana: 3000
- Node Exporter: 9100
- PostgreSQL Exporter: 9187
- Redis Exporter: 9121
- Nginx Exporter: 9113

## 快速启动

### 1. 启动监控系统

```bash
# 启动所有监控服务
./scripts/start-monitoring.sh start

# 检查服务状态
./scripts/start-monitoring.sh status

# 停止监控服务
./scripts/start-monitoring.sh stop

# 重启监控服务
./scripts/start-monitoring.sh restart

# 清理监控数据
./scripts/start-monitoring.sh cleanup
```

### 2. 访问监控界面

启动完成后，可以通过以下地址访问监控界面：

- **Prometheus**: http://localhost:9090
- **AlertManager**: http://localhost:9093
- **Grafana**: http://localhost:3000 (admin/admin123)

## Grafana配置

### 1. 登录Grafana

1. 访问 http://localhost:3000
2. 使用默认账号登录：
   - 用户名: admin
   - 密码: admin123

### 2. 添加数据源

1. 进入 **Configuration** > **Data Sources**
2. 点击 **Add data source**
3. 选择 **Prometheus**
4. 配置数据源：
   - URL: http://prometheus:9090
   - Access: Server (default)
5. 点击 **Save & Test**

### 3. 导入仪表板

1. 进入 **Dashboards** > **Import**
2. 上传 `grafana-dashboard.json` 文件
3. 选择刚创建的Prometheus数据源
4. 点击 **Import**

### 4. 仪表板功能

导入的仪表板包含以下面板：

#### 系统监控
- CPU使用率
- 内存使用率
- 磁盘使用率
- 网络流量

#### 应用监控
- API响应时间
- API请求量
- 错误率
- 活跃连接数

#### 数据库监控
- 数据库连接数
- 查询性能
- 锁等待时间

#### 缓存监控
- Redis连接数
- 缓存命中率
- 内存使用率

#### 业务监控
- 用户注册数
- 用户登录数
- 订单创建数
- 活跃用户数
- 总收入

## 告警配置

### 1. 告警规则

告警规则定义在 `alert_rules.yml` 文件中，包括：

#### 系统告警
- CPU使用率 > 80%
- 内存使用率 > 85%
- 磁盘使用率 > 90%

#### 应用告警
- API响应时间 > 2秒
- API错误率 > 5%
- 服务不可用

#### 数据库告警
- 连接数 > 80
- 查询时间 > 30秒

#### 缓存告警
- Redis内存使用率 > 85%
- 缓存命中率 < 80%

### 2. 告警通知

AlertManager配置在 `alertmanager.yml` 文件中，支持：

- 邮件通知
- 短信通知
- Webhook通知

### 3. 告警级别

- **Critical** - 严重告警，需要立即处理
- **Warning** - 警告告警，需要关注

## 应用监控集成

### 1. 后端监控

后端应用已经集成了监控中间件，提供以下指标：

```typescript
// 监控中间件
app.use(monitoringMiddleware);

// 指标导出端点
app.get('/metrics', metricsEndpoint);

// 健康检查端点
app.get('/health', healthCheck);
```

### 2. 监控指标

#### HTTP指标
- `http_request_duration_seconds` - 请求响应时间
- `http_requests_total` - 请求总数
- `http_active_connections` - 活跃连接数

#### 业务指标
- `user_registrations_total` - 用户注册数
- `user_logins_total` - 用户登录数
- `orders_created_total` - 订单创建数
- `active_users` - 活跃用户数
- `revenue_total` - 总收入

#### 性能指标
- `database_query_duration_seconds` - 数据库查询时间
- `redis_operation_duration_seconds` - Redis操作时间
- `cache_hit_rate` - 缓存命中率

### 3. 自定义指标

可以通过以下方式添加自定义指标：

```typescript
import { Counter, Gauge, Histogram } from 'prom-client';

// 自定义计数器
const customCounter = new Counter({
  name: 'custom_metric_total',
  help: '自定义指标'
});

// 自定义仪表
const customGauge = new Gauge({
  name: 'custom_gauge',
  help: '自定义仪表'
});

// 自定义直方图
const customHistogram = new Histogram({
  name: 'custom_histogram',
  help: '自定义直方图',
  buckets: [0.1, 0.5, 1, 2, 5]
});
```

## 性能优化

### 1. 数据保留策略

- Prometheus数据保留时间: 200小时
- 告警历史保留时间: 30天
- 日志文件轮转: 每天

### 2. 资源限制

- Prometheus内存限制: 2GB
- Grafana内存限制: 1GB
- 监控数据存储: 50GB

### 3. 高可用配置

- 多实例部署
- 负载均衡
- 数据备份

## 故障排除

### 1. 常见问题

#### 服务无法启动
```bash
# 检查Docker服务状态
docker info

# 检查端口占用
lsof -i :9090

# 查看容器日志
docker logs prometheus
```

#### 指标无法收集
```bash
# 检查目标状态
curl http://localhost:9090/api/v1/targets

# 检查指标端点
curl http://localhost:5000/metrics
```

#### 告警不触发
```bash
# 检查告警规则
curl http://localhost:9090/api/v1/rules

# 检查告警状态
curl http://localhost:9090/api/v1/alerts
```

### 2. 日志查看

```bash
# 查看Prometheus日志
docker logs prometheus

# 查看AlertManager日志
docker logs alertmanager

# 查看Grafana日志
docker logs grafana
```

### 3. 数据备份

```bash
# 备份Prometheus数据
docker cp prometheus:/prometheus ./backup/

# 备份Grafana配置
docker cp grafana:/etc/grafana ./backup/
```

## 安全配置

### 1. 访问控制

- Grafana用户管理
- Prometheus访问控制
- 告警通知认证

### 2. 网络安全

- 防火墙规则
- SSL证书配置
- 网络隔离

### 3. 数据安全

- 敏感数据加密
- 访问日志记录
- 定期安全审计

## 扩展配置

### 1. 添加新的监控目标

在 `prometheus.yml` 中添加新的监控目标：

```yaml
scrape_configs:
  - job_name: 'new-service'
    static_configs:
      - targets: ['localhost:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
```

### 2. 自定义告警规则

在 `alert_rules.yml` 中添加新的告警规则：

```yaml
- alert: CustomAlert
  expr: custom_metric > 100
  for: 5m
  labels:
    severity: warning
  annotations:
    summary: "自定义告警"
    description: "自定义指标超过阈值"
```

### 3. 添加新的数据源

在Grafana中添加新的数据源：

1. 进入 **Configuration** > **Data Sources**
2. 点击 **Add data source**
3. 选择相应的数据源类型
4. 配置连接参数
5. 测试连接并保存

## 最佳实践

### 1. 监控策略

- 分层监控：基础设施、应用、业务
- 关键指标优先
- 告警阈值合理设置
- 定期审查和优化

### 2. 告警管理

- 避免告警风暴
- 设置告警抑制规则
- 及时处理告警
- 定期清理已解决告警

### 3. 性能优化

- 合理设置采集间隔
- 优化查询性能
- 监控数据存储优化
- 定期清理历史数据

### 4. 文档维护

- 及时更新配置文档
- 记录故障处理过程
- 分享最佳实践
- 定期培训团队成员

## 总结

通过以上配置，我们建立了一个完整的监控体系，能够：

1. **实时监控** - 系统运行状态实时可见
2. **智能告警** - 异常情况及时通知
3. **性能分析** - 系统性能趋势分析
4. **故障诊断** - 问题快速定位和解决
5. **容量规划** - 基于数据做出扩容决策

这个监控体系为海南文旅系统的稳定运行提供了强有力的技术保障。 