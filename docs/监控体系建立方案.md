# 监控体系建立方案

## 概述

本文档详细描述了海南文旅系统监控体系的建立方案，包括系统监控、应用监控、性能监控、告警机制等。

## 监控架构

### 1. 监控体系架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Prometheus    │    │    Grafana      │    │   AlertManager  │
│   (数据收集)     │    │   (数据可视化)   │    │   (告警管理)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Node Exporter │    │   PM2 Monitor   │    │   Email/SMS     │
│   (系统监控)     │    │   (应用监控)     │    │   (通知渠道)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Application   │    │   Database      │    │   Redis Cache   │
│   (应用服务)     │    │   (数据库)       │    │   (缓存)         │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 2. 监控层次

#### 2.1 基础设施监控
- **系统资源**: CPU、内存、磁盘、网络
- **操作系统**: 进程、服务、日志
- **网络**: 连接数、带宽、延迟

#### 2.2 应用监控
- **应用服务**: 响应时间、错误率、吞吐量
- **数据库**: 连接数、查询性能、锁等待
- **缓存**: 命中率、内存使用、连接数

#### 2.3 业务监控
- **用户行为**: 访问量、用户活跃度
- **业务指标**: 订单量、转化率、收入
- **功能监控**: API调用、功能使用率

## 监控工具配置

### 1. Prometheus配置

#### 1.1 主配置文件 (prometheus.yml)
```yaml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

rule_files:
  - "alert_rules.yml"

alerting:
  alertmanagers:
    - static_configs:
        - targets:
          - localhost:9093

scrape_configs:
  # 系统监控
  - job_name: 'node-exporter'
    static_configs:
      - targets: ['localhost:9100']

  # 应用监控
  - job_name: 'hainan-tourism-api'
    static_configs:
      - targets: ['localhost:5000']
    metrics_path: '/metrics'
    scrape_interval: 10s

  # 数据库监控
  - job_name: 'postgres-exporter'
    static_configs:
      - targets: ['localhost:9187']

  # Redis监控
  - job_name: 'redis-exporter'
    static_configs:
      - targets: ['localhost:9121']

  # Nginx监控
  - job_name: 'nginx-exporter'
    static_configs:
      - targets: ['localhost:9113']
```

#### 1.2 告警规则 (alert_rules.yml)
```yaml
groups:
  - name: hainan-tourism-alerts
    rules:
      # 系统告警
      - alert: HighCPUUsage
        expr: 100 - (avg by(instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "CPU使用率过高"
          description: "CPU使用率超过80%持续5分钟"

      - alert: HighMemoryUsage
        expr: (node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "内存使用率过高"
          description: "内存使用率超过85%持续5分钟"

      - alert: HighDiskUsage
        expr: (node_filesystem_size_bytes - node_filesystem_avail_bytes) / node_filesystem_size_bytes * 100 > 90
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "磁盘使用率过高"
          description: "磁盘使用率超过90%持续5分钟"

      # 应用告警
      - alert: APIHighResponseTime
        expr: histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m])) > 2
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "API响应时间过长"
          description: "95%的API请求响应时间超过2秒"

      - alert: APIHighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) / rate(http_requests_total[5m]) * 100 > 5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "API错误率过高"
          description: "API错误率超过5%持续2分钟"

      # 数据库告警
      - alert: DatabaseHighConnections
        expr: pg_stat_database_numbackends > 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "数据库连接数过高"
          description: "数据库连接数超过80个持续5分钟"

      - alert: DatabaseSlowQueries
        expr: rate(pg_stat_activity_max_tx_duration[5m]) > 30
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "数据库查询过慢"
          description: "数据库查询时间超过30秒"

      # 缓存告警
      - alert: RedisHighMemoryUsage
        expr: redis_memory_used_bytes / redis_memory_max_bytes * 100 > 85
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis内存使用率过高"
          description: "Redis内存使用率超过85%持续5分钟"

      - alert: RedisLowHitRate
        expr: redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total) * 100 < 80
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Redis缓存命中率过低"
          description: "Redis缓存命中率低于80%持续5分钟"
```

### 2. Grafana配置

#### 2.1 仪表板配置
```json
{
  "dashboard": {
    "title": "海南文旅系统监控",
    "panels": [
      {
        "title": "系统资源使用率",
        "type": "graph",
        "targets": [
          {
            "expr": "100 - (avg by(instance) (irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
            "legendFormat": "CPU使用率"
          },
          {
            "expr": "(node_memory_MemTotal_bytes - node_memory_MemAvailable_bytes) / node_memory_MemTotal_bytes * 100",
            "legendFormat": "内存使用率"
          }
        ]
      },
      {
        "title": "API响应时间",
        "type": "graph",
        "targets": [
          {
            "expr": "histogram_quantile(0.95, rate(http_request_duration_seconds_bucket[5m]))",
            "legendFormat": "95%响应时间"
          }
        ]
      },
      {
        "title": "API请求量",
        "type": "graph",
        "targets": [
          {
            "expr": "rate(http_requests_total[5m])",
            "legendFormat": "请求量/秒"
          }
        ]
      },
      {
        "title": "数据库连接数",
        "type": "graph",
        "targets": [
          {
            "expr": "pg_stat_database_numbackends",
            "legendFormat": "连接数"
          }
        ]
      },
      {
        "title": "Redis缓存命中率",
        "type": "graph",
        "targets": [
          {
            "expr": "redis_keyspace_hits_total / (redis_keyspace_hits_total + redis_keyspace_misses_total) * 100",
            "legendFormat": "命中率"
          }
        ]
      }
    ]
  }
}
```

### 3. AlertManager配置

#### 3.1 主配置文件 (alertmanager.yml)
```yaml
global:
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alert@hainan-tourism.com'
  smtp_auth_username: 'your-email@gmail.com'
  smtp_auth_password: 'your-app-password'

route:
  group_by: ['alertname']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: 'web.hook'

receivers:
  - name: 'web.hook'
    webhook_configs:
      - url: 'http://localhost:5000/api/alerts'
        send_resolved: true

  - name: 'email'
    email_configs:
      - to: 'admin@hainan-tourism.com'
        send_resolved: true

  - name: 'sms'
    webhook_configs:
      - url: 'http://sms-gateway.com/send'
        send_resolved: true

inhibit_rules:
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['alertname']
```

## 应用监控实现

### 1. 应用监控中间件

#### 1.1 监控中间件 (monitoring.ts)
```typescript
import { Request, Response, NextFunction } from 'express';
import { register, Counter, Histogram, Gauge } from 'prom-client';

// 定义指标
const httpRequestDuration = new Histogram({
  name: 'http_request_duration_seconds',
  help: 'HTTP请求持续时间',
  labelNames: ['method', 'route', 'status_code'],
  buckets: [0.1, 0.5, 1, 2, 5]
});

const httpRequestsTotal = new Counter({
  name: 'http_requests_total',
  help: 'HTTP请求总数',
  labelNames: ['method', 'route', 'status_code']
});

const activeConnections = new Gauge({
  name: 'active_connections',
  help: '当前活跃连接数'
});

const databaseQueryDuration = new Histogram({
  name: 'database_query_duration_seconds',
  help: '数据库查询持续时间',
  labelNames: ['query_type'],
  buckets: [0.01, 0.05, 0.1, 0.5, 1, 2, 5]
});

// 监控中间件
export const monitoringMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();
  
  // 记录请求开始
  activeConnections.inc();
  
  res.on('finish', () => {
    const duration = (Date.now() - start) / 1000;
    const route = req.route?.path || req.path;
    
    // 记录请求指标
    httpRequestDuration
      .labels(req.method, route, res.statusCode.toString())
      .observe(duration);
    
    httpRequestsTotal
      .labels(req.method, route, res.statusCode.toString())
      .inc();
    
    // 减少活跃连接数
    activeConnections.dec();
  });
  
  next();
};

// 指标导出端点
export const metricsEndpoint = async (req: Request, res: Response) => {
  try {
    res.set('Content-Type', register.contentType);
    res.end(await register.metrics());
  } catch (error) {
    res.status(500).end(error);
  }
};

// 健康检查端点
export const healthCheck = async (req: Request, res: Response) => {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    uptime: process.uptime(),
    memory: process.memoryUsage(),
    version: process.version
  };
  
  res.json(health);
};

// 数据库监控
export const monitorDatabaseQuery = (queryType: string) => {
  return (target: any, propertyKey: string, descriptor: PropertyDescriptor) => {
    const originalMethod = descriptor.value;
    
    descriptor.value = async function(...args: any[]) {
      const start = Date.now();
      
      try {
        const result = await originalMethod.apply(this, args);
        const duration = (Date.now() - start) / 1000;
        
        databaseQueryDuration
          .labels(queryType)
          .observe(duration);
        
        return result;
      } catch (error) {
        const duration = (Date.now() - start) / 1000;
        
        databaseQueryDuration
          .labels(queryType)
          .observe(duration);
        
        throw error;
      }
    };
    
    return descriptor;
  };
};
```

### 2. 业务监控实现

#### 2.1 业务指标监控
```typescript
import { Counter, Gauge, Histogram } from 'prom-client';

// 业务指标
export const userRegistrations = new Counter({
  name: 'user_registrations_total',
  help: '用户注册总数'
});

export const userLogins = new Counter({
  name: 'user_logins_total',
  help: '用户登录总数'
});

export const ordersCreated = new Counter({
  name: 'orders_created_total',
  help: '订单创建总数'
});

export const revenueTotal = new Counter({
  name: 'revenue_total',
  help: '总收入'
});

export const activeUsers = new Gauge({
  name: 'active_users',
  help: '当前活跃用户数'
});

export const orderValue = new Histogram({
  name: 'order_value',
  help: '订单金额分布',
  buckets: [10, 50, 100, 200, 500, 1000, 2000, 5000]
});

// 业务监控装饰器
export const trackBusinessMetric = (metric: Counter | Gauge | Histogram, value?: number) => {
  return (target: any, propertyKey: string, descriptor: PropertyDescriptor) => {
    const originalMethod = descriptor.value;
    
    descriptor.value = async function(...args: any[]) {
      const result = await originalMethod.apply(this, args);
      
      if (metric instanceof Counter) {
        metric.inc();
      } else if (metric instanceof Gauge) {
        if (value !== undefined) {
          metric.set(value);
        } else {
          metric.inc();
        }
      } else if (metric instanceof Histogram) {
        if (value !== undefined) {
          metric.observe(value);
        }
      }
      
      return result;
    };
    
    return descriptor;
  };
};
```

## 日志监控

### 1. 日志配置

#### 1.1 日志中间件
```typescript
import winston from 'winston';
import { Request, Response, NextFunction } from 'express';

// 创建日志记录器
const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  defaultMeta: { service: 'hainan-tourism-api' },
  transports: [
    new winston.transports.File({ filename: '/var/log/hainan-tourism/error.log', level: 'error' }),
    new winston.transports.File({ filename: '/var/log/hainan-tourism/combined.log' })
  ]
});

if (process.env.NODE_ENV !== 'production') {
  logger.add(new winston.transports.Console({
    format: winston.format.simple()
  }));
}

// 日志中间件
export const loggingMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    
    logger.info('HTTP请求', {
      method: req.method,
      url: req.url,
      statusCode: res.statusCode,
      duration,
      userAgent: req.get('User-Agent'),
      ip: req.ip
    });
  });
  
  next();
};

// 错误日志中间件
export const errorLoggingMiddleware = (err: any, req: Request, res: Response, next: NextFunction) => {
  logger.error('应用错误', {
    error: err.message,
    stack: err.stack,
    method: req.method,
    url: req.url,
    userAgent: req.get('User-Agent'),
    ip: req.ip
  });
  
  next(err);
};

export { logger };
```

### 2. 日志分析

#### 2.1 日志分析脚本
```bash
#!/bin/bash

# 日志分析脚本
LOG_DIR="/var/log/hainan-tourism"
REPORT_FILE="/var/log/hainan-tourism/analysis_report.txt"

echo "海南文旅系统日志分析报告" > $REPORT_FILE
echo "生成时间: $(date)" >> $REPORT_FILE
echo "==========================================" >> $REPORT_FILE

# 分析错误日志
echo "错误日志分析:" >> $REPORT_FILE
echo "最近24小时错误数量: $(grep -c 'ERROR' $LOG_DIR/error.log)" >> $REPORT_FILE
echo "最近24小时致命错误数量: $(grep -c 'FATAL' $LOG_DIR/error.log)" >> $REPORT_FILE

# 分析访问日志
echo "访问日志分析:" >> $REPORT_FILE
echo "最近24小时请求总数: $(grep -c 'HTTP请求' $LOG_DIR/combined.log)" >> $REPORT_FILE
echo "最近24小时平均响应时间: $(grep 'HTTP请求' $LOG_DIR/combined.log | awk '{sum+=$NF} END {print sum/NR}')ms" >> $REPORT_FILE

# 分析慢查询
echo "慢查询分析:" >> $REPORT_FILE
echo "最近24小时慢查询数量: $(grep 'database_query_duration' $LOG_DIR/combined.log | awk '$NF > 1 {count++} END {print count}')" >> $REPORT_FILE

echo "==========================================" >> $REPORT_FILE
echo "分析完成"
```

## 性能监控

### 1. 性能指标收集

#### 1.1 性能监控中间件
```typescript
import { performance } from 'perf_hooks';
import { Request, Response, NextFunction } from 'express';

// 性能指标
const performanceMetrics = {
  requestCount: 0,
  totalResponseTime: 0,
  minResponseTime: Infinity,
  maxResponseTime: 0,
  errorCount: 0
};

// 性能监控中间件
export const performanceMonitoringMiddleware = (req: Request, res: Response, next: NextFunction) => {
  const start = performance.now();
  
  res.on('finish', () => {
    const duration = performance.now() - start;
    
    // 更新指标
    performanceMetrics.requestCount++;
    performanceMetrics.totalResponseTime += duration;
    performanceMetrics.minResponseTime = Math.min(performanceMetrics.minResponseTime, duration);
    performanceMetrics.maxResponseTime = Math.max(performanceMetrics.maxResponseTime, duration);
    
    if (res.statusCode >= 400) {
      performanceMetrics.errorCount++;
    }
  });
  
  next();
};

// 性能指标端点
export const performanceMetricsEndpoint = (req: Request, res: Response) => {
  const avgResponseTime = performanceMetrics.requestCount > 0 
    ? performanceMetrics.totalResponseTime / performanceMetrics.requestCount 
    : 0;
  
  const errorRate = performanceMetrics.requestCount > 0 
    ? (performanceMetrics.errorCount / performanceMetrics.requestCount) * 100 
    : 0;
  
  res.json({
    requestCount: performanceMetrics.requestCount,
    avgResponseTime: avgResponseTime.toFixed(2),
    minResponseTime: performanceMetrics.minResponseTime === Infinity ? 0 : performanceMetrics.minResponseTime.toFixed(2),
    maxResponseTime: performanceMetrics.maxResponseTime.toFixed(2),
    errorCount: performanceMetrics.errorCount,
    errorRate: errorRate.toFixed(2)
  });
};
```

### 2. 内存监控

#### 2.1 内存监控脚本
```typescript
import { performance } from 'perf_hooks';

// 内存监控
export const memoryMonitoring = () => {
  const memUsage = process.memoryUsage();
  
  return {
    rss: memUsage.rss,
    heapTotal: memUsage.heapTotal,
    heapUsed: memUsage.heapUsed,
    external: memUsage.external,
    arrayBuffers: memUsage.arrayBuffers
  };
};

// 内存泄漏检测
export const detectMemoryLeak = () => {
  const memUsage = memoryMonitoring();
  const heapUsedMB = memUsage.heapUsed / 1024 / 1024;
  
  if (heapUsedMB > 500) { // 500MB阈值
    console.warn('内存使用过高:', heapUsedMB.toFixed(2), 'MB');
  }
  
  return heapUsedMB;
};
```

## 告警通知

### 1. 邮件通知

#### 1.1 邮件通知服务
```typescript
import nodemailer from 'nodemailer';

// 邮件配置
const transporter = nodemailer.createTransporter({
  host: process.env.SMTP_HOST,
  port: parseInt(process.env.SMTP_PORT || '587'),
  secure: false,
  auth: {
    user: process.env.SMTP_USER,
    pass: process.env.SMTP_PASS
  }
});

// 发送告警邮件
export const sendAlertEmail = async (alert: any) => {
  const mailOptions = {
    from: process.env.SMTP_USER,
    to: 'admin@hainan-tourism.com',
    subject: `系统告警: ${alert.summary}`,
    html: `
      <h2>系统告警</h2>
      <p><strong>告警名称:</strong> ${alert.summary}</p>
      <p><strong>告警描述:</strong> ${alert.description}</p>
      <p><strong>告警级别:</strong> ${alert.severity}</p>
      <p><strong>告警时间:</strong> ${new Date().toISOString()}</p>
      <p><strong>实例:</strong> ${alert.instance}</p>
    `
  };
  
  try {
    await transporter.sendMail(mailOptions);
    console.log('告警邮件发送成功');
  } catch (error) {
    console.error('告警邮件发送失败:', error);
  }
};
```

### 2. 短信通知

#### 2.1 短信通知服务
```typescript
import axios from 'axios';

// 发送告警短信
export const sendAlertSMS = async (alert: any) => {
  const message = `系统告警: ${alert.summary} - ${alert.description}`;
  
  try {
    await axios.post('http://sms-gateway.com/send', {
      phone: process.env.ALERT_PHONE,
      message: message
    });
    console.log('告警短信发送成功');
  } catch (error) {
    console.error('告警短信发送失败:', error);
  }
};
```

## 监控部署

### 1. Docker Compose配置

#### 1.1 监控服务配置 (docker-compose.monitoring.yml)
```yaml
version: '3.8'

services:
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml
      - ./alert_rules.yml:/etc/prometheus/alert_rules.yml
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=200h'
      - '--web.enable-lifecycle'

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=admin123
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning

  alertmanager:
    image: prom/alertmanager:latest
    container_name: alertmanager
    ports:
      - "9093:9093"
    volumes:
      - ./alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'

  node-exporter:
    image: prom/node-exporter:latest
    container_name: node-exporter
    ports:
      - "9100:9100"
    volumes:
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
      - /:/rootfs:ro
    command:
      - '--path.procfs=/host/proc'
      - '--path.sysfs=/host/sys'
      - '--collector.filesystem.ignored-mount-points=^/(sys|proc|dev|host|etc)($$|/)'

volumes:
  prometheus_data:
  grafana_data:
  alertmanager_data:
```

### 2. 监控脚本

#### 2.1 监控启动脚本
```bash
#!/bin/bash

# 监控服务启动脚本
echo "启动监控服务..."

# 启动Prometheus
docker-compose -f docker-compose.monitoring.yml up -d prometheus

# 启动Grafana
docker-compose -f docker-compose.monitoring.yml up -d grafana

# 启动AlertManager
docker-compose -f docker-compose.monitoring.yml up -d alertmanager

# 启动Node Exporter
docker-compose -f docker-compose.monitoring.yml up -d node-exporter

echo "监控服务启动完成"
echo "Prometheus: http://localhost:9090"
echo "Grafana: http://localhost:3000 (admin/admin123)"
echo "AlertManager: http://localhost:9093"
```

## 监控检查清单

### 1. 基础设施监控
- [ ] CPU使用率监控
- [ ] 内存使用率监控
- [ ] 磁盘使用率监控
- [ ] 网络流量监控
- [ ] 系统负载监控

### 2. 应用监控
- [ ] API响应时间监控
- [ ] 错误率监控
- [ ] 吞吐量监控
- [ ] 活跃连接数监控
- [ ] 应用健康状态监控

### 3. 数据库监控
- [ ] 数据库连接数监控
- [ ] 查询性能监控
- [ ] 锁等待监控
- [ ] 数据库健康状态监控

### 4. 缓存监控
- [ ] Redis内存使用监控
- [ ] 缓存命中率监控
- [ ] 连接数监控
- [ ] 缓存健康状态监控

### 5. 业务监控
- [ ] 用户注册监控
- [ ] 用户登录监控
- [ ] 订单创建监控
- [ ] 收入监控
- [ ] 活跃用户监控

### 6. 告警配置
- [ ] 邮件告警配置
- [ ] 短信告警配置
- [ ] 告警规则配置
- [ ] 告警级别设置
- [ ] 告警抑制规则

## 总结

通过建立完整的监控体系，系统具备了：

1. **全面监控覆盖**: 从基础设施到业务指标的全面监控
2. **实时告警机制**: 多通道的告警通知机制
3. **可视化展示**: 直观的监控数据可视化
4. **性能分析**: 详细的性能指标分析
5. **日志管理**: 完整的日志收集和分析

这些监控措施为系统的稳定运行和问题排查提供了强有力的技术保障。 