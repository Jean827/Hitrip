# 部署环境准备方案

## 概述

本文档详细描述了海南文旅系统生产环境的部署准备方案，包括环境配置、安全设置、数据库配置、SSL证书配置等。

## 环境架构

### 1. 生产环境架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Nginx (80/443)│    │   Load Balancer │    │   CDN (CloudFlare)│
│   (反向代理)     │    │   (负载均衡)     │    │   (内容分发)     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Backend API   │    │   Frontend App  │    │   Static Assets │
│   (Node.js)     │    │   (React)       │    │   (Images/CSS/JS)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────┐    ┌─────────────────┐
│   Database      │    │   Redis Cache   │
│   (PostgreSQL)  │    │   (Session/Cache)│
└─────────────────┘    └─────────────────┘
```

### 2. 服务器配置

#### 2.1 应用服务器
```bash
# 服务器规格
CPU: 4核心
内存: 8GB
存储: 100GB SSD
网络: 100Mbps
操作系统: Ubuntu 22.04 LTS

# 软件环境
Node.js: 18.x LTS
Nginx: 1.24.x
PM2: 5.3.x
Docker: 24.x (可选)
```

#### 2.2 数据库服务器
```bash
# 服务器规格
CPU: 2核心
内存: 4GB
存储: 200GB SSD
网络: 100Mbps
操作系统: Ubuntu 22.04 LTS

# 软件环境
PostgreSQL: 15.x
Redis: 7.x
```

## 环境配置

### 1. 生产环境变量配置

#### 1.1 后端环境变量
```bash
# 应用配置
NODE_ENV=production
PORT=5000
HOST=0.0.0.0

# 数据库配置
POSTGRES_HOST=your-db-server.com
POSTGRES_PORT=5432
POSTGRES_DB=hainan_tourism_prod
POSTGRES_USER=hainan_user
POSTGRES_PASSWORD=your-secure-password

# Redis配置
REDIS_HOST=your-redis-server.com
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password
REDIS_DB=0

# 安全配置
JWT_SECRET=your-super-secret-jwt-key-256-bit
SESSION_SECRET=your-super-secret-session-key-256-bit
BCRYPT_ROUNDS=12

# 文件上传配置
UPLOAD_PATH=/var/www/uploads
MAX_FILE_SIZE=5242880
ALLOWED_FILE_TYPES=image/jpeg,image/png,image/gif,image/webp,application/pdf,text/plain

# 邮件配置
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# 第三方API配置
AMAP_API_KEY=your-amap-api-key
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret

# 监控配置
PROMETHEUS_PORT=9090
GRAFANA_PORT=3000
```

#### 1.2 前端环境变量
```bash
# 应用配置
VITE_APP_TITLE=海南文旅
VITE_APP_VERSION=1.0.0
VITE_API_BASE_URL=https://api.hainan-tourism.com
VITE_UPLOAD_URL=https://api.hainan-tourism.com/api/upload

# 第三方服务配置
VITE_AMAP_API_KEY=your-amap-api-key
VITE_GA_TRACKING_ID=your-ga-tracking-id

# 功能开关
VITE_ENABLE_ANALYTICS=true
VITE_ENABLE_CHAT=true
VITE_ENABLE_MAP=true
```

### 2. 数据库安全配置

#### 2.1 PostgreSQL配置
```sql
-- 创建生产数据库
CREATE DATABASE hainan_tourism_prod;

-- 创建专用用户
CREATE USER hainan_user WITH PASSWORD 'your-secure-password';

-- 授予权限
GRANT ALL PRIVILEGES ON DATABASE hainan_tourism_prod TO hainan_user;
GRANT ALL PRIVILEGES ON SCHEMA public TO hainan_user;

-- 安全配置
ALTER USER hainan_user SET search_path TO public;
ALTER USER hainan_user SET timezone TO 'Asia/Shanghai';
```

#### 2.2 Redis配置
```bash
# redis.conf 安全配置
bind 127.0.0.1
port 6379
requirepass your-redis-password
maxmemory 2gb
maxmemory-policy allkeys-lru
save 900 1
save 300 10
save 60 10000
```

### 3. SSL证书配置

#### 3.1 Let's Encrypt证书
```bash
# 安装Certbot
sudo apt update
sudo apt install certbot python3-certbot-nginx

# 获取SSL证书
sudo certbot --nginx -d hainan-tourism.com -d www.hainan-tourism.com

# 自动续期
sudo crontab -e
# 添加以下行
0 12 * * * /usr/bin/certbot renew --quiet
```

#### 3.2 Nginx SSL配置
```nginx
# /etc/nginx/sites-available/hainan-tourism
server {
    listen 80;
    server_name hainan-tourism.com www.hainan-tourism.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name hainan-tourism.com www.hainan-tourism.com;

    # SSL配置
    ssl_certificate /etc/letsencrypt/live/hainan-tourism.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hainan-tourism.com/privkey.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY always;
    add_header X-Content-Type-Options nosniff always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # 前端应用
    location / {
        root /var/www/hainan-tourism/frontend/dist;
        try_files $uri $uri/ /index.html;
        
        # 缓存配置
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }
    }

    # API代理
    location /api/ {
        proxy_pass http://localhost:5000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        
        # 超时配置
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # 文件上传
    location /uploads/ {
        alias /var/www/uploads/;
        expires 1y;
        add_header Cache-Control "public";
    }
}
```

## 部署脚本

### 1. 自动化部署脚本

#### 1.1 部署脚本 (deploy.sh)
```bash
#!/bin/bash

# 部署脚本
set -e

echo "🚀 开始部署海南文旅系统..."

# 环境变量
APP_NAME="hainan-tourism"
DEPLOY_PATH="/var/www/hainan-tourism"
BACKUP_PATH="/var/backups/hainan-tourism"
LOG_PATH="/var/log/hainan-tourism"

# 创建目录
sudo mkdir -p $DEPLOY_PATH
sudo mkdir -p $BACKUP_PATH
sudo mkdir -p $LOG_PATH
sudo mkdir -p /var/www/uploads

# 备份当前版本
if [ -d "$DEPLOY_PATH/current" ]; then
    echo "📦 备份当前版本..."
    sudo cp -r $DEPLOY_PATH/current $BACKUP_PATH/backup-$(date +%Y%m%d-%H%M%S)
fi

# 拉取最新代码
echo "📥 拉取最新代码..."
cd $DEPLOY_PATH
sudo git pull origin main

# 安装依赖
echo "📦 安装后端依赖..."
cd backend
sudo npm ci --production

echo "📦 安装前端依赖..."
cd ../frontend
sudo npm ci

# 构建前端
echo "🔨 构建前端应用..."
sudo npm run build

# 配置环境变量
echo "⚙️ 配置环境变量..."
sudo cp .env.production .env

# 数据库迁移
echo "🗄️ 执行数据库迁移..."
cd ../backend
sudo npm run migrate:prod

# 重启服务
echo "🔄 重启服务..."
sudo pm2 restart hainan-tourism-api || sudo pm2 start ecosystem.config.js

# 清理缓存
echo "🧹 清理缓存..."
sudo nginx -s reload

echo "✅ 部署完成!"
```

#### 1.2 PM2配置文件 (ecosystem.config.js)
```javascript
module.exports = {
  apps: [{
    name: 'hainan-tourism-api',
    script: './backend/src/index.ts',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 5000
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 5000
    },
    error_file: '/var/log/hainan-tourism/err.log',
    out_file: '/var/log/hainan-tourism/out.log',
    log_file: '/var/log/hainan-tourism/combined.log',
    time: true,
    max_memory_restart: '1G',
    node_args: '--max-old-space-size=1024',
    watch: false,
    ignore_watch: ['node_modules', 'logs'],
    merge_logs: true,
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z'
  }]
};
```

### 2. 监控脚本

#### 2.1 健康检查脚本 (health-check.sh)
```bash
#!/bin/bash

# 健康检查脚本
APP_URL="https://hainan-tourism.com"
API_URL="https://api.hainan-tourism.com"

echo "🏥 开始健康检查..."

# 检查前端应用
echo "📱 检查前端应用..."
FRONTEND_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $APP_URL)
if [ $FRONTEND_STATUS -eq 200 ]; then
    echo "✅ 前端应用正常"
else
    echo "❌ 前端应用异常: $FRONTEND_STATUS"
fi

# 检查API服务
echo "🔌 检查API服务..."
API_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $API_URL/health)
if [ $API_STATUS -eq 200 ]; then
    echo "✅ API服务正常"
else
    echo "❌ API服务异常: $API_STATUS"
fi

# 检查数据库连接
echo "🗄️ 检查数据库连接..."
DB_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $API_URL/api/health/db)
if [ $DB_STATUS -eq 200 ]; then
    echo "✅ 数据库连接正常"
else
    echo "❌ 数据库连接异常: $DB_STATUS"
fi

# 检查Redis连接
echo "🔴 检查Redis连接..."
REDIS_STATUS=$(curl -s -o /dev/null -w "%{http_code}" $API_URL/api/health/redis)
if [ $REDIS_STATUS -eq 200 ]; then
    echo "✅ Redis连接正常"
else
    echo "❌ Redis连接异常: $REDIS_STATUS"
fi

echo "🏥 健康检查完成!"
```

## 安全配置

### 1. 防火墙配置

#### 1.1 UFW防火墙
```bash
# 安装UFW
sudo apt install ufw

# 默认策略
sudo ufw default deny incoming
sudo ufw default allow outgoing

# 允许SSH
sudo ufw allow ssh

# 允许HTTP/HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp

# 允许应用端口
sudo ufw allow 5000/tcp

# 启用防火墙
sudo ufw enable
```

#### 1.2 Fail2ban配置
```bash
# 安装Fail2ban
sudo apt install fail2ban

# 配置SSH保护
sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.local
sudo nano /etc/fail2ban/jail.local

# 添加以下配置
[sshd]
enabled = true
port = ssh
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 3600
findtime = 600
```

### 2. 系统安全配置

#### 2.1 系统更新
```bash
# 更新系统
sudo apt update && sudo apt upgrade -y

# 安装安全工具
sudo apt install unattended-upgrades
sudo apt install rkhunter
sudo apt install chkrootkit
```

#### 2.2 用户安全
```bash
# 创建部署用户
sudo adduser deploy
sudo usermod -aG sudo deploy

# 禁用root登录
sudo nano /etc/ssh/sshd_config
# 设置 PermitRootLogin no

# 重启SSH服务
sudo systemctl restart ssh
```

## 监控配置

### 1. 系统监控

#### 1.1 系统资源监控
```bash
# 安装监控工具
sudo apt install htop iotop nethogs

# 配置日志轮转
sudo nano /etc/logrotate.d/hainan-tourism

# 添加配置
/var/log/hainan-tourism/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 www-data www-data
}
```

#### 1.2 应用监控
```bash
# 安装PM2监控
sudo npm install -g pm2
pm2 install pm2-logrotate

# 配置监控
pm2 set pm2-logrotate:max_size 10M
pm2 set pm2-logrotate:retain 30
pm2 set pm2-logrotate:compress true
```

### 2. 性能监控

#### 2.1 数据库监控
```sql
-- 创建监控视图
CREATE VIEW db_stats AS
SELECT 
    schemaname,
    tablename,
    attname,
    n_distinct,
    correlation
FROM pg_stats
WHERE schemaname = 'public';

-- 创建性能查询
SELECT 
    query,
    calls,
    total_time,
    mean_time,
    rows
FROM pg_stat_statements
ORDER BY total_time DESC
LIMIT 10;
```

#### 2.2 API监控
```javascript
// 监控中间件
app.use((req, res, next) => {
  const start = Date.now();
  
  res.on('finish', () => {
    const duration = Date.now() - start;
    console.log(`${req.method} ${req.path} - ${res.statusCode} - ${duration}ms`);
  });
  
  next();
});
```

## 备份策略

### 1. 数据库备份

#### 1.1 自动备份脚本
```bash
#!/bin/bash

# 数据库备份脚本
BACKUP_DIR="/var/backups/database"
DATE=$(date +%Y%m%d_%H%M%S)
DB_NAME="hainan_tourism_prod"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
pg_dump -h localhost -U hainan_user -d $DB_NAME > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "backup_*.sql.gz" -mtime +7 -delete

echo "数据库备份完成: backup_$DATE.sql.gz"
```

#### 1.2 备份定时任务
```bash
# 添加到crontab
sudo crontab -e

# 每天凌晨2点备份
0 2 * * * /var/scripts/backup-database.sh

# 每周日凌晨3点完整备份
0 3 * * 0 /var/scripts/backup-full.sh
```

### 2. 文件备份

#### 2.1 文件备份脚本
```bash
#!/bin/bash

# 文件备份脚本
BACKUP_DIR="/var/backups/files"
DATE=$(date +%Y%m%d_%H%M%S)

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份上传文件
tar -czf $BACKUP_DIR/uploads_$DATE.tar.gz /var/www/uploads/

# 备份配置文件
tar -czf $BACKUP_DIR/config_$DATE.tar.gz /var/www/hainan-tourism/

# 删除30天前的备份
find $BACKUP_DIR -name "*.tar.gz" -mtime +30 -delete

echo "文件备份完成"
```

## 部署检查清单

### 1. 环境检查
- [ ] 服务器规格满足要求
- [ ] 操作系统版本正确
- [ ] 网络连接正常
- [ ] 防火墙配置正确
- [ ] SSL证书有效

### 2. 软件安装
- [ ] Node.js 18.x 安装
- [ ] Nginx 安装配置
- [ ] PostgreSQL 安装配置
- [ ] Redis 安装配置
- [ ] PM2 安装配置

### 3. 安全配置
- [ ] 环境变量配置
- [ ] 数据库安全设置
- [ ] SSL证书配置
- [ ] 防火墙规则
- [ ] 用户权限设置

### 4. 应用部署
- [ ] 代码部署
- [ ] 依赖安装
- [ ] 环境变量配置
- [ ] 数据库迁移
- [ ] 服务启动

### 5. 监控配置
- [ ] 日志配置
- [ ] 监控脚本
- [ ] 告警设置
- [ ] 备份策略
- [ ] 健康检查

### 6. 测试验证
- [ ] 前端访问测试
- [ ] API接口测试
- [ ] 数据库连接测试
- [ ] 文件上传测试
- [ ] 安全功能测试

## 总结

通过完善的部署环境准备方案，系统具备了：

1. **高可用架构**: 负载均衡、CDN加速、多实例部署
2. **安全防护**: SSL证书、防火墙、安全配置
3. **监控体系**: 系统监控、应用监控、性能监控
4. **备份策略**: 数据库备份、文件备份、自动备份
5. **自动化部署**: 部署脚本、健康检查、监控告警

这些配置为系统的稳定运行和安全管理提供了强有力的保障。 